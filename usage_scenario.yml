---
name: RAG-System Test
author: Vincent Ro√ükencht <vincent.rossknecht@envite.de>
description: Dieser Test dient der Messung des Energieverbrauchs des RAG-Systems.

compose-file: !include docker-compose.gmt.yml

flow:
  # 0. Ollama Modell explizit pullen vor restlichem flow
  - name: Warten auf Ollama container
    container: ollama
    commands:
      - type: console
        command: sleep 20
        log-stdout: true

  - name: Ollama Modell pullen
    container: ollama
    commands:
      - type: console
        command: ollama pull llama3:8b
        log-stdout: true
        read-notes-stdout: true

  # 1. Warmup Indexing
  - name: Warmup Indexing
    container: rag-app
    commands:
      - type: console
        command: python -m app.warmup_indexing
        log-stdout: true
        read-notes-stdout: true

  - name: Pause nach Warmup Indexing
    container: rag-app
    commands:
      - type: console
        command: sleep 10

  # 2. Indexing
  - name: Indexing
    container: rag-app
    commands:
      - type: console
        command: python -m app.indexing
        log-stdout: true
        read-notes-stdout: true

  - name: Pause nach Indexing
    container: rag-app
    commands:
      - type: console
        command: sleep 10

  # 3. Warmup RAG
  - name: Warmup RAG
    container: rag-app
    commands:
      - type: console
        command: python -m app.warmup_rag
        log-stdout: true
        read-notes-stdout: true

  - name: Pause nach Warmup RAG
    container: rag-app
    commands:
      - type: console
        command: sleep 10

  # 4. RAG Querries
  - name: RAG Querries
    container: rag-app
    commands:
      - type: console
        command: >
          curl -X POST http://127.0.0.1:8000/ask
          -H "Content-Type: application/json"
          -d '{"question": "Was ist Nachhaltigkeit?"}'
        log-stdout: true
        read-notes-stdout: true

      - type: console
        command: sleep 5

      - type: console
        command: >
          curl -X POST http://127.0.0.1:8000/ask
          -H "Content-Type: application/json"
          -d '{"question": "Was ist ein Treibhausgas?"}'
        log-stdout: true
        read-notes-stdout: true